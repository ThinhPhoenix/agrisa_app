workflows:
  # Android Workflow
  react-native-android:
    name: React Native Android (Bun)
    instance_type: mac_mini_m1  # Hoáº·c mac_pro Ä‘á»ƒ cÃ³ nhiá»u RAM hÆ¡n
    max_build_duration: 120
    environment:
      groups:
        - expo_url
      vars:
        EXPO_PROJECT_SLUG: "agrisa"
        # ThÃªm biáº¿n Ä‘á»ƒ tÄƒng heap size
        GRADLE_OPTS: "-Xmx4096m -XX:MaxMetaspaceSize=1024m"
      node: 18
    cache:
      cache_paths:
        - $CM_BUILD_DIR/node_modules
    scripts:
      - name: Install Bun vÃ  dependencies
        script: |
          curl -fsSL https://bun.sh/install | bash
          source ~/.bashrc || true
          export PATH="$HOME/.bun/bin:$PATH"
          
          which bun && bun --version
          bun install
          bun add -g @expo/cli
      
      - name: Setup Environment Variables
        script: |
          if [ -z "$EXPO_PUBLIC_API_URL" ]; then
            echo "âŒ ERROR: EXPO_PUBLIC_API_URL is not set!"
            echo "Please check Codemagic environment group 'expo_url'"
            exit 1
          fi
          
          echo "âœ… Environment variables loaded:"
          echo "EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL"
          export EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL
      
      - name: Expo Prebuild for Android
        script: |
          export PATH="$HOME/.bun/bin:$PATH"
          export EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL
          
          rm -rf android
          bunx expo prebuild --platform android
          
          if grep -r "EXPO_PUBLIC_API_URL" android/; then
            echo "âœ… API URL has been embedded in Android build"
          else
            echo "âš ï¸ Warning: API URL might not be embedded"
          fi
      
      - name: Set up debug.keystore for Android
        script: |
          rm -f ~/.android/debug.keystore
          keytool -genkeypair -alias androiddebugkey -keypass android \
            -keystore ~/.android/debug.keystore -storepass android \
            -dname 'CN=Android Debug,O=Android,C=US' -keyalg 'RSA' \
            -keysize 2048 -validity 10000
      
      - name: Build Android APK
        script: |
          cd android
          
          # Set heap size cho Gradle
          export GRADLE_OPTS="-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError"
          export EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL
          
          # Clean trÆ°á»›c khi build
          ./gradlew clean
          
          # Build vá»›i parallel disabled Ä‘á»ƒ giáº£m memory usage
          ./gradlew assembleRelease --no-daemon --max-workers=2
          
          # Kiá»ƒm tra APK
          if [ -f app/build/outputs/apk/release/app-release.apk ]; then
            echo "âœ… APK built successfully"
            ls -lh app/build/outputs/apk/release/app-release.apk
          else
            echo "âŒ APK build failed"
            exit 1
          fi
    
    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/outputs/**/*.aab
    
    publishing:
      email:
        recipients:
          - nhancd909@gmail.com
          - hgiap46@gmail.com
        notify:
          success: true
          failure: false

  # iOS IPA Build for AltStore/Sideloading
  react-native-ios-ipa:
    name: React Native iOS IPA (AltStore Compatible)
    instance_type: mac_mini_m1
    max_build_duration: 120
    environment:
      groups:
        - expo_url 
      vars:
        BUNDLE_ID: "com.tnhaan.agrisa"
        EXPO_PROJECT_SLUG: "agrisa"
        APP_NAME: "Agrisa"
      node: 18
      xcode: latest
      cocoapods: default
    cache:
      cache_paths:
        - $CM_BUILD_DIR/node_modules
    scripts:
      - name: Install Bun vÃ  dependencies
        script: |
          curl -fsSL https://bun.sh/install | bash
          source ~/.bashrc || true
          export PATH="$HOME/.bun/bin:$PATH"
          
          which bun && bun --version
          bun install
          bun add -g @expo/cli
      
      - name: Setup Environment Variables
        script: |
          if [ -z "$EXPO_PUBLIC_API_URL" ]; then
            echo "âŒ ERROR: EXPO_PUBLIC_API_URL is not set!"
            exit 1
          fi
          
          echo "âœ… EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL"
          export EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL
      
      - name: Expo Prebuild for iOS
        script: |
          export PATH="$HOME/.bun/bin:$PATH"
          export EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL
          
          rm -rf ios
          bunx expo prebuild --platform ios
      
      - name: Modify Xcode Project for Unsigned Build
        script: |
          echo "ðŸ”§ Configuring Xcode project for unsigned build..."
          
          # TÃ¬m file pbxproj
          PBXPROJ_FILE="ios/Agrisa.xcodeproj/project.pbxproj"
          
          if [ -f "$PBXPROJ_FILE" ]; then
            # Backup file gá»‘c
            cp "$PBXPROJ_FILE" "$PBXPROJ_FILE.backup"
            
            # Disable automatic code signing
            sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' "$PBXPROJ_FILE"
            
            echo "âœ… Xcode project configured"
          else
            echo "âš ï¸ Warning: pbxproj file not found"
          fi
      
      - name: Install CocoaPods dependencies
        script: |
          cd ios && pod install
      
      - name: Build iOS App Bundle
        script: |
          export EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL
          
          echo "ðŸ”¨ Building iOS .app bundle..."
          
          # Build cho iOS device (khÃ´ng archive, chá»‰ build .app)
          xcodebuild \
            -workspace ios/Agrisa.xcworkspace \
            -scheme Agrisa \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath $CM_BUILD_DIR/build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            build
          
          if [ $? -eq 0 ]; then
            echo "âœ… Build completed successfully"
          else
            echo "âŒ Build failed"
            exit 1
          fi
      
      - name: Create IPA from .app Bundle
        script: |
          echo "ðŸ“¦ Creating IPA from .app bundle..."
          
          # TÃ¬m file .app
          APP_PATH=$(find $CM_BUILD_DIR/build/Build/Products/Release-iphoneos -name "*.app" -type d | head -1)
          
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ .app bundle not found!"
            echo "Searching for .app files..."
            find $CM_BUILD_DIR/build -name "*.app" -type d
            exit 1
          fi
          
          echo "âœ… Found .app bundle: $APP_PATH"
          
          # Táº¡o cáº¥u trÃºc Payload cho IPA
          mkdir -p $CM_BUILD_DIR/output/Payload
          
          # Copy .app vÃ o Payload
          cp -R "$APP_PATH" $CM_BUILD_DIR/output/Payload/
          
          # Táº¡o file IPA (chá»‰ lÃ  file ZIP vá»›i extension .ipa)
          cd $CM_BUILD_DIR/output
          zip -r Agrisa.ipa Payload
          
          # Cleanup
          rm -rf Payload
          
          # Verify IPA
          if [ -f "Agrisa.ipa" ]; then
            echo "âœ… IPA created successfully"
            ls -lh Agrisa.ipa
            
            # Show IPA info
            unzip -l Agrisa.ipa | head -20
          else
            echo "âŒ Failed to create IPA"
            exit 1
          fi
      
      - name: Verify IPA Structure
        script: |
          echo "ðŸ” Verifying IPA structure..."
          
          cd $CM_BUILD_DIR/output
          
          # Extract IPA Ä‘á»ƒ kiá»ƒm tra
          mkdir -p ipa_check
          unzip -q Agrisa.ipa -d ipa_check
          
          # Check bundle structure
          if [ -d "ipa_check/Payload/Agrisa.app" ]; then
            echo "âœ… IPA structure is valid"
            
            # Show bundle info
            echo "ðŸ“‹ Bundle contents:"
            ls -la ipa_check/Payload/Agrisa.app/ | head -20
            
            # Check Info.plist
            if [ -f "ipa_check/Payload/Agrisa.app/Info.plist" ]; then
              echo "âœ… Info.plist found"
              plutil -p ipa_check/Payload/Agrisa.app/Info.plist | grep -E "CFBundleIdentifier|CFBundleVersion|CFBundleDisplayName"
            fi
          else
            echo "âŒ Invalid IPA structure"
            ls -la ipa_check/
            exit 1
          fi
          
          # Cleanup
          rm -rf ipa_check
      
      - name: Create Installation Instructions
        script: |
          echo "ðŸ“ Creating installation guide..."
          
          cat > $CM_BUILD_DIR/output/INSTALL_GUIDE.md << 'EOF'
          # HÆ°á»›ng dáº«n cÃ i Ä‘áº·t Agrisa IPA
          
          ## YÃªu cáº§u
          - iPhone/iPad cháº¡y iOS 14.0 trá»Ÿ lÃªn
          - AltStore hoáº·c Sideloadly Ä‘Ã£ cÃ i Ä‘áº·t
          - Káº¿t ná»‘i WiFi á»•n Ä‘á»‹nh
          
          ## CÃ¡ch 1: Sá»­ dá»¥ng AltStore (Khuyáº¿n nghá»‹)
          
          ### BÆ°á»›c 1: CÃ i Ä‘áº·t AltStore
          1. Táº£i AltServer tá»«: https://altstore.io/
          2. CÃ i Ä‘áº·t trÃªn mÃ¡y tÃ­nh (Windows/Mac)
          3. Káº¿t ná»‘i iPhone qua WiFi (cÃ¹ng máº¡ng vá»›i mÃ¡y tÃ­nh)
          
          ### BÆ°á»›c 2: CÃ i Ä‘áº·t app
          1. Gá»­i file `Agrisa.ipa` vá» iPhone (AirDrop/Email/iCloud)
          2. Má»Ÿ AltStore trÃªn iPhone
          3. Chá»n tab "My Apps"
          4. Nháº¥n nÃºt "+"
          5. Chá»n file `Agrisa.ipa`
          6. ÄÄƒng nháº­p Apple ID khi Ä‘Æ°á»£c yÃªu cáº§u
          7. Chá» AltStore resign vÃ  cÃ i Ä‘áº·t app
          
          ### BÆ°á»›c 3: Trust Certificate
          1. Má»Ÿ Settings â†’ General â†’ VPN & Device Management
          2. TÃ¬m profile cá»§a Apple ID báº¡n vá»«a dÃ¹ng
          3. Nháº¥n "Trust"
          
          ## CÃ¡ch 2: Sá»­ dá»¥ng Sideloadly
          
          ### BÆ°á»›c 1: Táº£i Sideloadly
          - Download: https://sideloadly.io/
          - Há»— trá»£ Windows/Mac/Linux
          
          ### BÆ°á»›c 2: CÃ i Ä‘áº·t
          1. Káº¿t ná»‘i iPhone qua USB
          2. Má»Ÿ Sideloadly
          3. KÃ©o tháº£ file `Agrisa.ipa` vÃ o Sideloadly
          4. Nháº­p Apple ID vÃ  password
          5. Nháº¥n "Start"
          6. Chá» quÃ¡ trÃ¬nh hoÃ n táº¥t
          
          ### BÆ°á»›c 3: Trust Certificate
          - TÆ°Æ¡ng tá»± nhÆ° cÃ¡ch 1
          
          ## LÆ°u Ã½ quan trá»ng
          
          ### Thá»i háº¡n app
          - **Free Apple ID**: App háº¿t háº¡n sau 7 ngÃ y
          - **Paid Developer Account**: App háº¿t háº¡n sau 1 nÄƒm
          - Cáº§n refresh qua AltStore trÆ°á»›c khi háº¿t háº¡n
          
          ### Giá»›i háº¡n
          - Tá»‘i Ä‘a 3 apps vá»›i free account
          - AltServer pháº£i cháº¡y khi refresh app
          
          ### Troubleshooting
          
          **Lá»—i "Untrusted Developer"**
          - VÃ o Settings â†’ General â†’ VPN & Device Management
          - Trust certificate
          
          **App khÃ´ng má»Ÿ Ä‘Æ°á»£c**
          - Kiá»ƒm tra app chÆ°a háº¿t háº¡n
          - Refresh qua AltStore
          
          **AltStore khÃ´ng tháº¥y mÃ¡y**
          - Äáº£m báº£o cÃ¹ng máº¡ng WiFi
          - Restart AltServer vÃ  AltStore
          
          ## Há»— trá»£
          Náº¿u gáº·p váº¥n Ä‘á», liÃªn há»‡:
          - Email: nhancd909@gmail.com
          - Email: hgiap46@gmail.com
          EOF
          
          echo "âœ… Installation guide created"
      
      - name: Generate QR Code for Download (Optional)
        script: |
          echo "ðŸ“± Installation ready"
          echo ""
          echo "==================================================="
          echo "âœ… IPA BUILD THÃ€NH CÃ”NG!"
          echo "==================================================="
          echo ""
          echo "ðŸ“¦ File: Agrisa.ipa"
          echo "ðŸ“ Size: $(ls -lh $CM_BUILD_DIR/output/Agrisa.ipa | awk '{print $5}')"
          echo "ðŸ“‹ Bundle ID: com.tnhaan.agrisa"
          echo ""
          echo "ðŸ“– Xem file INSTALL_GUIDE.md Ä‘á»ƒ biáº¿t cÃ¡ch cÃ i Ä‘áº·t"
          echo ""
          echo "==================================================="
    
    artifacts:
      - output/Agrisa.ipa
      - output/INSTALL_GUIDE.md
    
    publishing:
      email:
        recipients:
          - nhancd909@gmail.com
          - hgiap46@gmail.com
        notify:
          success: true
          failure: true